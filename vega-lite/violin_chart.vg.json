{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Violin plot showing AQI distribution by state using precomputed KDE",
  "data": {
    "url": "../data/api/aqi_kde_by_state.csv",
    "format": {
      "type": "csv",
      "parse": {
        "aqi": "number",
        "density": "number"
      }
    }
  },
  "transform": [
    {
      "filter": "isValid(datum.aqi) && isValid(datum.density)"
    },
    {
      "lookup": "state",
      "from": {
        "data": {
          "url": "../data/api/mean_aqi_per_state.csv",
          "format": {
            "type": "csv",
            "parse": {
              "mean_aqi": "number"
            }
          }
        },
        "key": "state",
        "fields": ["mean_aqi"]
      }
    }
  ],
  "facet": {
    "row": {
      "field": "state",
      "type": "nominal",
      "title": "State",
      "sort": {
        "field": "mean_aqi",
        "op": "mean",
        "order": "descending"
      }
    }
  },
  "spec": {
    "width": 400,
    "height": 80,
    "layer": [
      {
        "mark": "area",
        "encoding": {
          "x": {
            "field": "aqi",
            "type": "quantitative",
            "title": "Air Quality Index (AQI)",
            "scale": {
              "zero": false,
              "domain": [0, 120]
            }
          },
          "y": {
            "field": "density",
            "type": "quantitative",
            "title": "",
            "axis": {
              "labels": false,
              "ticks": false,
              "grid": false
            },
            "stack": "zero"
          },
          "color": {
            "field": "state",
            "type": "nominal",
            "legend": null
          }
        }
      },
      {
        "mark": {
          "type": "rule",
          "color": "black",
          "strokeWidth": 0.1,
          "strokeDash": [8, 4]
        },
        "encoding": {
          "x": {
            "field": "mean_aqi",
            "type": "quantitative"
          }
        }
      }
    ]
  }
}